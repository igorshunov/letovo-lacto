import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
from io import BytesIO

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(page_title="–ê–Ω–∞–ª–∏–∑ –±–∞–∫—Ç–µ—Ä–∏–π", page_icon="üî¨")
st.title("üî¨ –ê–Ω–∞–ª–∏–∑ –¥–∏–Ω–∞–º–∏–∫–∏ –±–∞–∫—Ç–µ—Ä–∏–π")

# –î–æ–±–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞
st.markdown("""
**–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –í–∞—Å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –í–∞—Ä–≤–∞—Ä–∞ –ì–æ–≤–æ—Ä—É—Ö–∏–Ω–∞, –∏ —ç—Ç–æ –º–æ–π –ø—Ä–æ–µ–∫—Ç –ø–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏–µ–º 
"–ê–Ω–∞–ª–∏–∑ –∞–Ω—Ç–∏–º–∏–∫—Ä–æ–±–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –º–æ–ª–æ—á–Ω–æ–∫–∏—Å–ª—ã—Ö –±–∞–∫—Ç–µ—Ä–∏–π –≤ –æ—Ç–Ω–æ—à–µ–Ω–∏–∏ –º–∏–∫—Ä–æ—Ñ–ª–æ—Ä—ã —Ä—É–∫". 
–ù–∞ —ç—Ç–æ–º —Å–∞–π—Ç–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–æ–∏—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π.**
""")

st.write("–ó–∞–≥—Ä—É–∑–∏—Ç–µ Excel-—Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –±–∞–∫—Ç–µ—Ä–∏–π –ø–æ –¥–Ω—è–º")

def process_file(uploaded_file):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –±–∞–∫—Ç–µ—Ä–∏—è—Ö"""
    try:
        # –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
        df = pd.read_excel(uploaded_file)
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
        if len(df.columns) < 2:
            st.error("–û—à–∏–±–∫–∞: –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å—Ç–æ–ª–±—Ü–∞ (–Ω–∞–∑–≤–∞–Ω–∏—è –±–∞–∫—Ç–µ—Ä–∏–π –∏ –¥–∞–Ω–Ω—ã–µ –ø–æ –¥–Ω—è–º)")
            return None
            
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        # –ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü - –Ω–∞–∑–≤–∞–Ω–∏—è –±–∞–∫—Ç–µ—Ä–∏–π
        bacteria_col = df.columns[0]
        
        # –°–æ–∑–¥–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        melted_df = df.melt(
            id_vars=[bacteria_col],
            var_name='–î–µ–Ω—å',
            value_name='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ'
        )
        
        return melted_df, df
    
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: {e}")
        return None, None

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
uploaded_file = st.file_uploader("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª", type=['xlsx', 'xls'])

if uploaded_file is not None:
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞
    melted_df, original_df = process_file(uploaded_file)
    
    if melted_df is not None and original_df is not None:
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        st.subheader("–ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ")
        st.dataframe(original_df)
        
        # –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ —Å—Ç–æ–ª–±—á–∞—Ç–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞)
        if not melted_df.empty:
            fig_bar = px.bar(
                melted_df,
                x='–î–µ–Ω—å',
                y='–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                color=original_df.columns[0],  # –ü–µ—Ä–≤—ã–π —Å—Ç–æ–ª–±–µ—Ü —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –±–∞–∫—Ç–µ—Ä–∏–π
                barmode='group',
                title='–î–∏–Ω–∞–º–∏–∫–∞ –±–∞–∫—Ç–µ—Ä–∏–π –ø–æ –¥–Ω—è–º',
                labels={original_df.columns[0]: '–¢–∏–ø –±–∞–∫—Ç–µ—Ä–∏–π'}
            )
            st.plotly_chart(fig_bar)

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å –∞—Ä–µ–∞–ª–æ–º —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è
st.markdown("---")
st.subheader("–ê—Ä–µ–∞–ª —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∫—Ç–µ—Ä–∏–π")

# –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
st.markdown("""
**–ì–ª–∞–≤–Ω–æ–π –º–æ–µ–π –∑–∞–¥–∞—á–µ–π –±—ã–ª–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–ª–æ—á–Ω–æ–∫–∏—Å–ª—ã—Ö –±–∞–∫—Ç–µ—Ä–∏–π —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∞–Ω—Ç–∏–º–∏–∫—Ä–æ–±–Ω—ã–º –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ–º. 
–í —ç—Ç–æ–π —Ç–∞–±–ª–∏—Ü–µ –º–æ–∂–Ω–æ —É–≤–∏–¥–µ—Ç—å —Å—Ä–µ–¥–Ω–µ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ –±–∞–∫—Ç–µ—Ä–∏–π –Ω–∞ –º–∏–∫—Ä–æ–±—ã.**
""")

# –°–æ–∑–¥–∞–µ–º DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Ñ–∞–π–ª–∞
areal_data = {
    "–ü—Ä–æ–¥—É–∫—Ç": [
        "¬´–ü—Ä–æ–±–∏–æ—Ç–∏–∫¬ª",
        "¬´–ë–∏—Ñ–∏–¥—É–º¬ª",
        "¬´–ë–∏–æ–π–æ–≥—É—Ä—Ç¬ª",
        "¬´–ù–∞—Ä–∏–Ω—ç¬ª",
        "¬´–ê—Ü–∏–¥–æ—Ñ–∏–ª—å–Ω—ã–π –π–æ–≥—É—Ä—Ç¬ª"
    ],
    "–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞": [
        "–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è ‚Äì 4 –º–º",
        "–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è ‚Äì 3,8 –º–º",
        "–°—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏—è ‚Äì 2,4 –º–º",
        "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–±–∞–∫—Ç–µ—Ä–∏–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏–ª–∏—Å—å —Ç–∞–º –∂–µ, –≥–¥–µ –º–∏–∫—Ä–æ–±—ã)",
        "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö (–±–∞–∫—Ç–µ—Ä–∏–∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–∏–ª–∏—Å—å —Ç–∞–º –∂–µ, –≥–¥–µ –º–∏–∫—Ä–æ–±—ã)"
    ]
}

areal_df = pd.DataFrame(areal_data)
st.dataframe(areal_df, hide_index=True)

# –í—ã–≤–æ–¥ –ø–æ—Å–ª–µ —Ç–∞–±–ª–∏—Ü—ã
st.markdown("""
**–ü—Ä–æ–±–∏–æ—Ç–∏–∫, –ë–∏—Ñ–∏–¥—É–º –∏ –ë–∏–æ–π–æ–≥—É—Ä—Ç –ø–æ–¥–∞–≤–∏–ª–∏ –±–æ–ª—å—à–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–∏–∫—Ä–æ–±–æ–≤, 
–∞ –ù–∞—Ä–∏–Ω—ç –∏ –ê—Ü–∏–¥–æ—Ñ–∏–ª—å–Ω—ã–π –π–æ–≥—É—Ä—Ç –Ω–µ —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å —Å —ç—Ç–æ–π –∑–∞–¥–∞—á–µ–π.**
""")

# –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ –∏–∑ —Ñ–∞–π–ª–∞ "–î–∏–∞–≥—Ä–∞–º–º–∞_–±–∞–∫—Ç–µ—Ä–∏–∏.xlsx"
st.markdown("---")
st.subheader("–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞–∑–≤–∏—Ç–∏—è –±–∞–∫—Ç–µ—Ä–∏–π")

# –û–ø–∏—Å–∞–Ω–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞
st.markdown("""
**–Ø –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ 5 —Ä–∞–∑–Ω—ã—Ö —Å–º–µ—Å–µ–π, –≤ –∫–∞–∂–¥–æ–π –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–æ–≤ –±–∞–∫—Ç–µ—Ä–∏–π. 
–ó–¥–µ—Å—å –º–æ–∂–Ω–æ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≤—ã—Ä–æ—Å—à–∏—Ö —à—Ç–∞–º–º–æ–≤ —Å—Ä–µ–¥–∏ —Å–º–µ—Å–µ–π –∑–∞ 2 –¥–Ω—è –Ω–∞–±–ª—é–¥–µ–Ω–∏—è.**
""")

# –°–æ–∑–¥–∞–µ–º DataFrame —Å –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
permanent_data = {
    "–¢–∏–ø –±–∞–∫—Ç–µ—Ä–∏–π": [
        "–õ–∞–∫—Ç–æ–±–∞–∫—Ç–µ—Ä–∏–∏",
        "–°—Ç—Ä–µ–ø—Ç–æ–∫–æ–∫–∫–∏",
        "–õ–∞–∫—Ç–æ–∫–æ–∫–∫–∏",
        "–ü—Ä–æ–ø–∏–æ–Ω–∏–±–∞–∫—Ç–µ—Ä–∏–∏"
    ],
    "–î–µ–Ω—å 1": [4, 3, 2, 1],
    "–î–µ–Ω—å 2": [3, 3, 2, 1]
}
permanent_df = pd.DataFrame(permanent_data)

# –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ –¥–ª–∏–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
melted_permanent_df = permanent_df.melt(
    id_vars=["–¢–∏–ø –±–∞–∫—Ç–µ—Ä–∏–π"],
    var_name="–î–µ–Ω—å",
    value_name="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ"
)

# –°–æ–∑–¥–∞–µ–º –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –¥–∏–∞–≥—Ä–∞–º–º—É
fig_permanent = px.bar(
    melted_permanent_df,
    x="–î–µ–Ω—å",
    y="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ",
    color="–¢–∏–ø –±–∞–∫—Ç–µ—Ä–∏–π",
    barmode="group",
    title="–î–∏–Ω–∞–º–∏–∫–∞ —Ä–∞–∑–≤–∏—Ç–∏—è –±–∞–∫—Ç–µ—Ä–∏–π –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å–º–µ—Å—è—Ö",
    labels={"–¢–∏–ø –±–∞–∫—Ç–µ—Ä–∏–π": "–¢–∏–ø –±–∞–∫—Ç–µ—Ä–∏–π"},
    color_discrete_sequence=px.colors.qualitative.Pastel
)

st.plotly_chart(fig_permanent)

# –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ
st.write("–î–∞–Ω–Ω—ã–µ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º—ã:")
st.dataframe(permanent_df, hide_index=True)

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ—Ä–∞ —Ñ–∞–π–ª–∞
st.markdown("---")
st.subheader("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
if st.button("–°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"):
    # –¢–∏–ø—ã –±–∞–∫—Ç–µ—Ä–∏–π
    bacteria_types = [
        '–õ–∞–∫—Ç–æ–±–∞–∫—Ç–µ—Ä–∏–∏', 
        '–°—Ç—Ä–µ–ø—Ç–æ–∫–æ–∫–∫–∏', 
        '–õ–∞–∫—Ç–æ–∫–æ–∫–∫–∏', 
        '–ü—Ä–æ–ø–∏–æ–Ω–∏–±–∞–∫—Ç–µ—Ä–∏–∏',
        '–ë–∏—Ñ–∏–¥–æ–±–∞–∫—Ç–µ—Ä–∏–∏'
    ]
    
    # –°–æ–∑–¥–∞–µ–º DataFrame —Å –¥–∞–Ω–Ω—ã–º–∏
    days = 5
    data = {
        '–¢–∏–ø –±–∞–∫—Ç–µ—Ä–∏–π': bacteria_types
    }
    
    # –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
    for day in range(1, days + 1):
        # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π —Å —Ä–∞–∑–Ω–æ–π –¥–∏–Ω–∞–º–∏–∫–æ–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –±–∞–∫—Ç–µ—Ä–∏–π
        day_data = []
        for i, bacteria in enumerate(bacteria_types):
            base = np.random.randint(1, 10)
            trend = np.random.choice([-1, 0, 1])
            value = max(1, base + trend * (day - 1) + np.random.randint(-1, 2))
            day_data.append(value)
        data[f'–î–µ–Ω—å {day}'] = day_data
    
    sample_df = pd.DataFrame(data)
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –≤ –ø–∞–º—è—Ç–∏
    output = BytesIO()
    with pd.ExcelWriter(output, engine='openpyxl') as writer:
        sample_df.to_excel(writer, index=False)
    
    # –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    st.download_button(
        label="üì• –°–∫–∞—á–∞—Ç—å –ø—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞",
        data=output.getvalue(),
        file_name="sample_bacteria.xlsx",
        mime="application/vnd.ms-excel"
    )
    
    # –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    st.write("–ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö:")
    st.dataframe(sample_df)